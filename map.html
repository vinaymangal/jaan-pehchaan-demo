<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jaan Pehchaan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            max-width: 430px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            min-height: 100vh;
        }

        /* Mobile-first header */
        .header {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .header h1 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .header p {
            color: #666;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Map container */
        .map-container {
            position: relative;
            height: calc(100vh - 80px);
            width: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Mobile search bar */
        .search-container {
            position: absolute;
            top: 1rem;
            left: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }

        .search-box {
            flex: 1;
            background: white;
            border: none;
            border-radius: 25px;
            padding: 12px 16px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box:focus {
            outline: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* Profile button - mobile friendly */
        .profile-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-btn:active {
            transform: scale(0.95);
        }

        /* Emergency help button - mobile centered */
        .emergency-help {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255,71,87,0.3);
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(255,71,87,0.3); }
            50% { box-shadow: 0 6px 20px rgba(255,71,87,0.5); }
        }

        .emergency-help:active {
            transform: translateX(-50%) scale(0.95);
        }

        /* Mobile action buttons */
        .action-buttons {
            position: absolute;
            bottom: 6rem;
            left: 1rem;
            right: 1rem;
            z-index: 1000;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .action-btn {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 11px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn .icon {
            font-size: 18px;
            margin-bottom: 2px;
        }

        /* Connection info panel - mobile bottom sheet */
        .connection-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 50vh;
            overflow-y: auto;
        }

        .connection-info.show {
            transform: translateY(0);
        }

        .connection-info h3 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 1.2rem;
        }

        .connection-detail {
            margin-bottom: 0.75rem;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .connection-detail:last-child {
            border-bottom: none;
        }

        .connection-detail .label {
            font-weight: 500;
            color: #666;
        }

        .connection-detail .value {
            color: #333;
            text-align: right;
        }

        .degree-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .degree-1 { background: #2ecc71; }
        .degree-2 { background: #f39c12; }
        .degree-3 { background: #3498db; }
        .degree-4 { background: #e74c3c; }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }

        .request-help-btn {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }

        .request-help-btn:active {
            transform: scale(0.98);
        }

        /* Advanced Controls - Hidden by default, mobile friendly */
        .advanced-controls {
            position: absolute;
            top: 4rem;
            right: 1rem;
            background: white;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 250px;
            width: calc(100vw - 2rem);
        }

        .advanced-controls.show {
            transform: translateX(0);
        }

        .controls-toggle {
            position: absolute;
            top: 4rem;
            right: 1rem;
            z-index: 1001;
            background: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            margin-bottom: 1rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #666;
            font-size: 12px;
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .control-btn {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            margin: 4px 0;
        }

        /* Custom marker styles */
        .leaflet-marker-icon {
            border-radius: 50% !important;
            border: 2px solid white !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }

        /* User marker */
        .user-marker {
            background: #2ecc71 !important;
            color: white !important;
            font-size: 16px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            animation: userPulse 2s infinite;
        }

        @keyframes userPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Connection markers by degree */
        .connection-marker-1 {
            background: #2ecc71 !important;
            color: white !important;
        }

        .connection-marker-2 {
            background: #f39c12 !important;
            color: white !important;
        }

        .connection-marker-3 {
            background: #3498db !important;
            color: white !important;
        }

        .connection-marker-4 {
            background: #e74c3c !important;
            color: white !important;
        }

        /* Connection lines */
        .connection-line {
            stroke-width: 2;
            stroke-opacity: 0.6;
            fill: none;
            pointer-events: none;
            animation: connectionPulse 3s infinite;
        }

        @keyframes connectionPulse {
            0%, 100% { stroke-opacity: 0.6; }
            50% { stroke-opacity: 1; }
        }

        .line-degree-1 { stroke: #2ecc71; }
        .line-degree-2 { stroke: #f39c12; stroke-dasharray: 5,5; }
        .line-degree-3 { stroke: #3498db; stroke-dasharray: 3,3; }
        .line-degree-4 { stroke: #e74c3c; stroke-dasharray: 2,2; }

        /* Help path animation */
        .help-path {
            stroke: #ff4757;
            stroke-width: 4;
            stroke-opacity: 0.8;
            fill: none;
            stroke-dasharray: 10,5;
            animation: pathFlow 2s linear infinite;
        }

        @keyframes pathFlow {
            0% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 0; }
        }

        /* Clustering styles */
        .marker-cluster {
            background: rgba(52, 152, 219, 0.8) !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            color: white !important;
            font-weight: bold !important;
            text-align: center !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }

        .marker-cluster div {
            background: rgba(52, 152, 219, 0.9) !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            line-height: 36px !important;
        }

        /* Loading and notifications */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 5rem;
            left: 1rem;
            right: 1rem;
            background: #2ecc71;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            z-index: 10000;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.warning {
            background: #f39c12;
        }

        /* Tour mode styles */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: none;
        }

        .tour-tooltip {
            position: absolute;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 280px;
            z-index: 10001;
        }

        .tour-highlight {
            position: absolute;
            border: 3px solid #3498db;
            border-radius: 10px;
            animation: tourPulse 2s infinite;
            z-index: 10001;
        }

        @keyframes tourPulse {
            0%, 100% { border-color: #3498db; box-shadow: 0 0 0 0 rgba(52,152,219,0.7); }
            50% { border-color: #2ecc71; box-shadow: 0 0 0 10px rgba(46,204,113,0); }
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }
            
            .action-btn {
                font-size: 10px;
                padding: 10px 6px;
            }
            
            .action-btn .icon {
                font-size: 16px;
            }
            
            .advanced-controls {
                width: calc(100vw - 1rem);
                right: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay"></div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Header -->
    <div class="header">
        <h1>Jaan Pehchaan</h1>
        <p>जान पहचान • Know & Recognize</p>
    </div>

    <!-- Map Container -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" class="search-box" id="searchBox" 
                   placeholder="Search institutions, connections..." />
        </div>

        <!-- Profile Button -->
        <button class="profile-btn" onclick="goToProfile()">
            👤
        </button>

        <!-- Controls Toggle -->
        <button class="controls-toggle" onclick="toggleAdvancedControls()">
            ⚙️
        </button>

        <!-- Advanced Controls -->
        <div class="advanced-controls" id="advancedControls">
            <div class="control-group">
                <label>Connection Degree:</label>
                <select id="degreeFilter" onchange="filterByDegree()">
                    <option value="all">All Degrees</option>
                    <option value="1">1st Degree</option>
                    <option value="2">2nd Degree</option>
                    <option value="3">3rd Degree</option>
                    <option value="4">4th Degree</option>
                </select>
            </div>

            <div class="control-group">
                <label>Institution Type:</label>
                <select id="institutionFilter" onchange="filterByInstitution()">
                    <option value="all">All Types</option>
                    <option value="government">Government</option>
                    <option value="bank">Banks</option>
                    <option value="hospital">Hospitals</option>
                    <option value="company">Companies</option>
                    <option value="education">Education</option>
                </select>
            </div>

            <button class="control-btn" onclick="toggleConnectionLines()">
                Toggle Lines
            </button>
            
            <button class="control-btn" onclick="simulateHelpPath()">
                Simulate Path
            </button>
            
            <button class="control-btn" onclick="resetMap()">
                Reset Map
            </button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn" onclick="findNearby()">
                <div class="icon">📍</div>
                <div>Find Nearby</div>
            </button>
            <button class="action-btn" onclick="goToConnections()">
                <div class="icon">👥</div>
                <div>My Network</div>
            </button>
            <button class="action-btn" onclick="goToAbout()">
                <div class="icon">❓</div>
                <div>How It Works</div>
            </button>
            <button class="action-btn" onclick="goToHistory()">
                <div class="icon">📊</div>
                <div>My History</div>
            </button>
        </div>

        <!-- Emergency Help Button -->
        <button class="emergency-help" onclick="emergencyHelp()">
            🚨 Need Help Now!
        </button>

        <!-- Connection Info Panel -->
        <div class="connection-info" id="connectionInfo">
            <button class="close-btn" onclick="hideConnectionInfo()">×</button>
            <h3 id="connectionName">Connection Details</h3>
            
            <div class="connection-detail">
                <span class="label">Role:</span>
                <span class="value" id="connectionRole">-</span>
            </div>
            
            <div class="connection-detail">
                <span class="label">Institution:</span>
                <span class="value" id="connectionInstitution">-</span>
            </div>
            
            <div class="connection-detail">
                <span class="label">Department:</span>
                <span class="value" id="connectionDepartment">-</span>
            </div>
            
            <div class="connection-detail">
                <span class="label">Can Help With:</span>
                <span class="value" id="connectionHelp">-</span>
            </div>
            
            <div class="connection-detail">
                <span class="label">Response Time:</span>
                <span class="value" id="connectionResponse">-</span>
            </div>
            
            <div class="connection-detail">
                <span class="label">Success Rate:</span>
                <span class="value" id="connectionSuccess">-</span>
            </div>

            <button class="request-help-btn" onclick="requestHelp()">
                📞 Request Help
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/d3@7"></script>
    <script>
        // Global variables
        let map;
        let userLocation = [28.6139, 77.2090]; // Delhi
        let markerCluster;
        let connectionLines = [];
        let helpPath = null;
        let showLines = true;
        let currentFilter = { degree: 'all', institution: 'all' };
        let allMarkers = [];
        let svgLayer;
        let currentConnection = null;

        // Sample connections data - Mobile optimized
        const connections = [
            // 1st degree - Green markers
            { id: 1, name: "Rajesh Kumar", degree: 1, lat: 28.6289, lng: 77.2065, institution: "government", role: "IAS Officer", department: "Revenue Department", help: "Property documents", response: "2 hours", success: "96%" },
            { id: 2, name: "Priya Sharma", degree: 1, lat: 28.6229, lng: 77.2294, institution: "bank", role: "Branch Manager", department: "Loan Department", help: "Business loans", response: "1 hour", success: "92%" },
            { id: 3, name: "Dr. Amit Singh", degree: 1, lat: 28.6169, lng: 77.2025, institution: "hospital", role: "Cardiologist", department: "Cardiology", help: "Heart checkups", response: "4 hours", success: "98%" },
            { id: 4, name: "Neha Gupta", degree: 1, lat: 28.6089, lng: 77.2240, institution: "company", role: "HR Director", department: "Human Resources", help: "Job referrals", response: "3 hours", success: "89%" },
            
            // 2nd degree - Orange markers
            { id: 5, name: "Sandeep Verma", degree: 2, lat: 28.6389, lng: 77.2165, institution: "government", role: "Municipal Commissioner", department: "Urban Development", help: "City planning", response: "1 day", success: "87%" },
            { id: 6, name: "Meera Joshi", degree: 2, lat: 28.6129, lng: 77.2394, institution: "bank", role: "Investment Advisor", department: "Wealth Management", help: "Investment advice", response: "4 hours", success: "91%" },
            { id: 7, name: "Dr. Rahul Kapoor", degree: 2, lat: 28.6269, lng: 77.1925, institution: "hospital", role: "Surgeon", department: "General Surgery", help: "Surgical consultations", response: "8 hours", success: "95%" },
            { id: 8, name: "Ankita Malhotra", degree: 2, lat: 28.6089, lng: 77.2340, institution: "company", role: "Tech Lead", department: "Software Development", help: "Tech consulting", response: "2 hours", success: "93%" },
            
            // 3rd degree - Blue markers
            { id: 9, name: "Vikram Yadav", degree: 3, lat: 28.6489, lng: 77.2265, institution: "government", role: "District Collector", department: "Administration", help: "Administrative support", response: "2 days", success: "85%" },
            { id: 10, name: "Kavita Agarwal", degree: 3, lat: 28.6029, lng: 77.2494, institution: "bank", role: "Regional Manager", department: "Operations", help: "Banking services", response: "1 day", success: "86%" },
            { id: 11, name: "Dr. Pooja Reddy", degree: 3, lat: 28.6369, lng: 77.1825, institution: "hospital", role: "Pediatrician", department: "Pediatrics", help: "Child healthcare", response: "6 hours", success: "97%" },
            { id: 12, name: "Rohit Bhardwaj", degree: 3, lat: 28.5989, lng: 77.2440, institution: "company", role: "Marketing Head", department: "Marketing", help: "Business promotion", response: "4 hours", success: "84%" },
            
            // 4th degree - Red markers
            { id: 13, name: "Harsh Agarwal", degree: 4, lat: 28.6589, lng: 77.2365, institution: "government", role: "Joint Secretary", department: "Policy Planning", help: "Policy guidance", response: "3 days", success: "82%" },
            { id: 14, name: "Ritu Saxena", degree: 4, lat: 28.5929, lng: 77.2594, institution: "bank", role: "Chief Manager", department: "Credit Department", help: "Credit solutions", response: "2 days", success: "83%" },
            { id: 15, name: "Dr. Manoj Khanna", degree: 4, lat: 28.6469, lng: 77.1725, institution: "hospital", role: "Radiologist", department: "Radiology", help: "Medical imaging", response: "1 day", success: "91%" }
        ];

        // Initialize map
        function initMap() {
            // Create map
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView(userLocation, 13);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            // Add zoom control to bottom right
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Create SVG overlay for connection lines
            createSVGLayer();

            // Create marker cluster
            markerCluster = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class="marker-cluster"><div>${count}</div></div>`,
                        className: 'cluster-marker',
                        iconSize: [40, 40]
                    });
                },
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                maxClusterRadius: 60
            });

            // Add user marker
            addUserMarker();
            
            // Add connection markers
            addConnectionMarkers();
            
            // Add markers to map
            map.addLayer(markerCluster);
            
            // Draw connection lines
            drawConnectionLines();

            // Check for tour mode
            checkTourMode();
        }

        // Create SVG layer for lines
        function createSVGLayer() {
            svgLayer = L.svg().addTo(map);
        }

        // Add user marker
        function addUserMarker() {
            const userIcon = L.divIcon({
                html: '<div class="user-marker">📍</div>',
                className: 'leaflet-marker-icon user-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            L.marker(userLocation, { icon: userIcon })
                .bindPopup('<b>You are here</b><br>Delhi, India')
                .addTo(map);
        }

        // Add connection markers
        function addConnectionMarkers() {
            allMarkers = [];
            
            connections.forEach(connection => {
                // Create marker with degree-based styling
                const icon = L.divIcon({
                    html: `<div class="connection-marker-${connection.degree}">${getInstitutionIcon(connection.institution)}</div>`,
                    className: `leaflet-marker-icon connection-marker-${connection.degree}`,
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                });

                const marker = L.marker([connection.lat, connection.lng], { icon: icon })
                    .bindPopup(createPopupContent(connection))
                    .on('click', () => showConnectionInfo(connection));

                marker.connectionData = connection;
                allMarkers.push(marker);
                markerCluster.addLayer(marker);
            });
        }

        // Get institution icon
        function getInstitutionIcon(institution) {
            const icons = {
                government: '🏛️',
                bank: '🏦',
                hospital: '🏥',
                company: '🏢',
                education: '🎓'
            };
            return icons[institution] || '📍';
        }

        // Create popup content
        function createPopupContent(connection) {
            return `
                <div style="text-align: center; min-width: 200px;">
                    <h4 style="margin-bottom: 8px;">${connection.name}</h4>
                    <p style="margin-bottom: 4px;"><strong>${connection.role}</strong></p>
                    <p style="margin-bottom: 4px;">📍 ${connection.department}</p>
                    <p style="margin-bottom: 8px;">🔗 ${connection.degree}${getDegreeSuffix(connection.degree)} degree connection</p>
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 8px; margin-top: 8px;">
                        <p style="margin: 2px 0; font-size: 12px;">⏱️ Response: ${connection.response}</p>
                        <p style="margin: 2px 0; font-size: 12px;">✅ Success: ${connection.success}</p>
                        <p style="margin: 2px 0; font-size: 12px;">💼 ${connection.help}</p>
                    </div>
                </div>
            `;
        }

        function getDegreeSuffix(degree) {
            const suffixes = { 1: 'st', 2: 'nd', 3: 'rd' };
            return suffixes[degree] || 'th';
        }

        // Draw connection lines
        function drawConnectionLines() {
            if (!showLines) return;

            const svg = d3.select("#map").select("svg").select("g");
            if (svg.empty()) {
                const svgElement = d3.select("#map").select("svg");
                const g = svgElement.append("g").attr("class", "leaflet-zoom-hide");
            }

            // Clear existing lines
            d3.select("#map").select("svg").selectAll(".connection-line").remove();

            // Get filtered connections
            const filteredConnections = getFilteredConnections();

            // Draw lines
            filteredConnections.forEach(connection => {
                const userPoint = map.latLngToLayerPoint(userLocation);
                const connectionPoint = map.latLngToLayerPoint([connection.lat, connection.lng]);

                d3.select("#map").select("svg").select("g")
                    .append("line")
                    .attr("class", `connection-line line-degree-${connection.degree}`)
                    .attr("x1", userPoint.x)
                    .attr("y1", userPoint.y)
                    .attr("x2", connectionPoint.x)
                    .attr("y2", connectionPoint.y);
            });
        }

        // Update connection lines on map move
        function updateConnectionLines() {
            if (!showLines) return;

            const filteredConnections = getFilteredConnections();
            
            d3.select("#map").select("svg").selectAll(".connection-line")
                .each(function(d, i) {
                    if (i < filteredConnections.length) {
                        const connection = filteredConnections[i];
                        const userPoint = map.latLngToLayerPoint(userLocation);
                        const connectionPoint = map.latLngToLayerPoint([connection.lat, connection.lng]);
                        
                        d3.select(this)
                            .attr("x1", userPoint.x)
                            .attr("y1", userPoint.y)
                            .attr("x2", connectionPoint.x)
                            .attr("y2", connectionPoint.y);
                    }
                });
        }

        // Get filtered connections
        function getFilteredConnections() {
            return connections.filter(conn => {
                const degreeMatch = currentFilter.degree === 'all' || conn.degree == currentFilter.degree;
                const institutionMatch = currentFilter.institution === 'all' || conn.institution === currentFilter.institution;
                return degreeMatch && institutionMatch;
            });
        }

        // Show connection info (mobile bottom sheet)
        function showConnectionInfo(connection) {
            currentConnection = connection;
            
            // Update info panel
            document.getElementById('connectionName').innerHTML = 
                `${connection.name} <span class="degree-badge degree-${connection.degree}">${connection.degree}°</span>`;
            document.getElementById('connectionRole').textContent = connection.role;
            document.getElementById('connectionInstitution').textContent = connection.institution.charAt(0).toUpperCase() + connection.institution.slice(1);
            document.getElementById('connectionDepartment').textContent = connection.department;
            document.getElementById('connectionHelp').textContent = connection.help;
            document.getElementById('connectionResponse').textContent = connection.response;
            document.getElementById('connectionSuccess').textContent = connection.success;
            
            // Show panel
            document.getElementById('connectionInfo').classList.add('show');
        }

        // Hide connection info
        function hideConnectionInfo() {
            document.getElementById('connectionInfo').classList.remove('show');
            currentConnection = null;
        }

        // Toggle advanced controls
        function toggleAdvancedControls() {
            const controls = document.getElementById('advancedControls');
            controls.classList.toggle('show');
        }

        // Filter functions
        function filterByDegree() {
            const degree = document.getElementById('degreeFilter').value;
            currentFilter.degree = degree;
            updateMapDisplay();
        }

        function filterByInstitution() {
            const institution = document.getElementById('institutionFilter').value;
            currentFilter.institution = institution;
            updateMapDisplay();
        }

        function updateMapDisplay() {
            // Clear and rebuild markers
            markerCluster.clearLayers();
            
            const filteredConnections = getFilteredConnections();
            const filteredMarkers = allMarkers.filter(marker => 
                filteredConnections.some(conn => conn.id === marker.connectionData.id)
            );
            
            filteredMarkers.forEach(marker => markerCluster.addLayer(marker));
            
            // Redraw connection lines
            drawConnectionLines();
            
            showNotification(`Showing ${filteredConnections.length} connections`);
        }

        // Toggle connection lines
        function toggleConnectionLines() {
            showLines = !showLines;
            if (showLines) {
                drawConnectionLines();
                showNotification('Connection lines enabled', 'success');
            } else {
                d3.select("#map").select("svg").selectAll(".connection-line").remove();
                showNotification('Connection lines disabled');
            }
        }

        // Simulate help path
        function simulateHelpPath() {
            if (helpPath) {
                map.removeLayer(helpPath);
            }

            // Select random connections for demo
            const targetConnection = connections[Math.floor(Math.random() * connections.length)];
            const intermediateConnection = connections.find(conn => 
                conn.degree === 1 && conn.institution === targetConnection.institution
            ) || connections.find(conn => conn.degree === 1);

            // Create animated path
            const pathCoords = [
                userLocation,
                [intermediateConnection.lat, intermediateConnection.lng],
                [targetConnection.lat, targetConnection.lng]
            ];

            helpPath = L.polyline(pathCoords, {
                className: 'help-path',
                weight: 4,
                opacity: 0.8,
                color: '#ff4757'
            }).addTo(map);

            showNotification(`Help path: You → ${intermediateConnection.name} → ${targetConnection.name}`, 'success');

            // Remove path after 8 seconds
            setTimeout(() => {
                if (helpPath) {
                    map.removeLayer(helpPath);
                    helpPath = null;
                }
            }, 8000);
        }

        // Reset map
        function resetMap() {
            map.setView(userLocation, 13);
            document.getElementById('degreeFilter').value = 'all';
            document.getElementById('institutionFilter').value = 'all';
            currentFilter = { degree: 'all', institution: 'all' };
            updateMapDisplay();
            hideConnectionInfo();
            showNotification('Map reset to default view');
        }

        // Navigation functions
        function goToProfile() {
            showLoading();
            setTimeout(() => window.location.href = 'profile.html', 500);
        }

        function goToConnections() {
            showLoading();
            setTimeout(() => window.location.href = 'connections.html', 500);
        }

        function goToAbout() {
            showLoading();
            setTimeout(() => window.location.href = 'about.html', 500);
        }

        function goToHistory() {
            showLoading();
            setTimeout(() => window.location.href = 'history.html', 500);
        }

        function emergencyHelp() {
            showLoading();
            setTimeout(() => window.location.href = 'help-request.html?urgent=true', 500);
        }

        function requestHelp() {
            if (currentConnection) {
                showLoading();
                setTimeout(() => {
                    window.location.href = `help-request.html?connection=${currentConnection.id}`;
                }, 500);
            }
        }

        // Search functionality
        function performSearch() {
            const query = document.getElementById('searchBox').value.toLowerCase().trim();
            if (!query) return;

            const results = connections.filter(conn => 
                conn.name.toLowerCase().includes(query) ||
                conn.role.toLowerCase().includes(query) ||
                conn.institution.toLowerCase().includes(query) ||
                conn.help.toLowerCase().includes(query)
            );

            if (results.length > 0) {
                const firstResult = results[0];
                map.setView([firstResult.lat, firstResult.lng], 15);
                showConnectionInfo(firstResult);
                showNotification(`Found ${results.length} result(s)`, 'success');
            } else {
                showNotification('No results found', 'error');
            }
        }

        // Find nearby
        function findNearby() {
            const nearbyCount = Math.floor(Math.random() * 6) + 3;
            showNotification(`Found ${nearbyCount} connections within 2km`, 'success');
            map.setZoom(12);
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Tour mode
        function checkTourMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('tour') === 'true') {
                setTimeout(startTour, 1000);
            }
        }

        function startTour() {
            const tourSteps = [
                {
                    element: '.user-marker',
                    title: 'Your Location',
                    text: 'This is your current location in Delhi. All connections are mapped around you.',
                    position: 'bottom'
                },
                {
                    element: '.search-container',
                    title: 'Smart Search',
                    text: 'Search for institutions, people, or types of help you need.',
                    position: 'bottom'
                },
                {
                    element: '.leaflet-marker-icon.connection-marker-1',
                    title: 'Your Connections',
                    text: 'Green dots are direct connections, orange are 2nd degree, blue are 3rd degree, red are 4th degree.',
                    position: 'top'
                },
                {
                    element: '.action-buttons',
                    title: 'Quick Actions',
                    text: 'Find nearby connections, view your network, learn how it works, or check your history.',
                    position: 'top'
                },
                {
                    element: '.emergency-help',
                    title: 'Emergency Help',
                    text: 'Need urgent assistance? This connects you to your most responsive nearby connections.',
                    position: 'top'
                }
            ];
            
            runTour(tourSteps);
        }

        function runTour(steps) {
            let currentStep = 0;
            const overlay = document.getElementById('tourOverlay');
            
            function showStep(stepIndex) {
                if (stepIndex >= steps.length) {
                    endTour();
                    return;
                }
                
                const step = steps[stepIndex];
                const element = document.querySelector(step.element);
                
                if (!element) {
                    setTimeout(() => showStep(stepIndex + 1), 500);
                    return;
                }
                
                overlay.style.display = 'block';
                overlay.innerHTML = '';
                
                // Create highlight
                const rect = element.getBoundingClientRect();
                const highlight = document.createElement('div');
                highlight.className = 'tour-highlight';
                highlight.style.left = rect.left - 5 + 'px';
                highlight.style.top = rect.top - 5 + 'px';
                highlight.style.width = rect.width + 10 + 'px';
                highlight.style.height = rect.height + 10 + 'px';
                overlay.appendChild(highlight);
                
                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'tour-tooltip';
                tooltip.innerHTML = `
                    <h4>${step.title}</h4>
                    <p>${step.text}</p>
                    <div style="margin-top: 15px; text-align: right;">
                        <button onclick="nextTourStep()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 5px;">
                            Next (${stepIndex + 1}/${steps.length})
                        </button>
                    </div>
                `;
                
                // Position tooltip
                let tooltipTop = rect.bottom + 10;
                let tooltipLeft = rect.left;
                
                if (step.position === 'top') {
                    tooltipTop = rect.top - 120;
                }
                
                // Keep tooltip on screen
                tooltipLeft = Math.max(10, Math.min(tooltipLeft, window.innerWidth - 300));
                tooltipTop = Math.max(10, Math.min(tooltipTop, window.innerHeight - 150));
                
                tooltip.style.left = tooltipLeft + 'px';
                tooltip.style.top = tooltipTop + 'px';
                
                overlay.appendChild(tooltip);
            }
            
            window.nextTourStep = function() {
                currentStep++;
                showStep(currentStep);
            };
            
            function endTour() {
                overlay.style.display = 'none';
                overlay.innerHTML = '';
                showNotification('Map tour completed! Try clicking on any colored dot to see connection details.', 'success');
                
                // Continue tour
                setTimeout(() => {
                    window.location.href = 'help-request.html?tour=true';
                }, 2000);
            }
            
            showStep(0);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Map events
            map.on('zoomend moveend', updateConnectionLines);
            
            // Search on Enter
            document.getElementById('searchBox').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // Hide connection info on map click
            map.on('click', function(e) {
                // Only hide if not clicking on a marker
                if (!e.originalEvent.target.closest('.leaflet-marker-icon')) {
                    hideConnectionInfo();
                }
            });

            // Hide advanced controls when clicking outside
            document.addEventListener('click', function(e) {
                const controls = document.getElementById('advancedControls');
                const toggle = document.querySelector('.controls-toggle');
                
                if (!controls.contains(e.target) && !toggle.contains(e.target)) {
                    controls.classList.remove('show');
                }
            });
        });

        // Touch events for mobile
        let touchStartY = 0;
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            const touchEndY = e.changedTouches[0].clientY;
            const touchDiff = touchStartY - touchEndY;
            
            // Swipe up to open connection info (if hidden)
            if (touchDiff > 50 && !document.getElementById('connectionInfo').classList.contains('show')) {
                // Could implement quick connection discovery here
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('searchBox').focus();
            }
            if (e.altKey && e.key === 'h') {
                e.preventDefault();
                emergencyHelp();
            }
            if (e.key === 'Escape') {
                hideConnectionInfo();
                document.getElementById('advancedControls').classList.remove('show');
            }
        });
    </script>
</body>
</html>